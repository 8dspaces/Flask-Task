{% extends "layout.html" %}
{% block content_class %} content {% endblock content_class %}

{% block subtitle %}
    <li ><a href="{{ url_for('public.scripts') }}">scripts</a></li>
    <li class="active"><a href="{{ url_for('public.create_job', script_id=script.id) }}">{{ script.name }} </a></li>
{% endblock %}

{% block js %}
    <script type=text/javascript>
    {% if job and not job.stopped_at %}

    $(document).ready(function () {

        status_check_interval = setInterval(
              function(){
              $.getJSON("{{ url_for('public.job_json', job_id=job.id) }}", {
              }, function(data) {
                console.log("what if");
                $("#status").attr('class', 'status status-' + data.status);
                $("#console-body").text(data.console);

                $("#download-button").attr('class', 'large-3 columns download-button download-' + data.has_output);

                // Iterate and add the tabs for content (if they don't already exist)
                for (var d in data.display) {
                    // Check existence of the tab already
                    a = $("#section-"+d+"-a")

                    if(a.length){ // Exists, replace content
                            console.log("what if");
                            a.html(d+' <span class="label round">'+data.display[d].count+' </span>')
                            s = $("#section-"+d)
                            var is_active = s.hasClass('active')
                            s.replaceWith(data.display[d].content)
                            if (is_active){
                                $("#section-"+d).addClass('active')
                            }

                    // } else { // Doesn't exist, create
                    //     $("#content-tabs").append(
                    //         '<li id="section-'+d+'-tab" class="tab-title content-tab" role="presentational" ><a id="section-'+d+'-a" href="#section-'+d+'" role="tab" tabindex="0" aria-selected="" controls="section-'+d+'">'+d+' <span class="label round">'+data.display[d].count+' </span></a></li>')
                    //     $('#tab-content').append(data.display[d].content)
                    // }
                     } else { // Doesn't exist, create
                     //$("#content-tabs").append('<li id="section-'+d+'-tab" class="tab-title content-tab" role="presentational" ><a id="section-'+d+'-a" href="#section-'+d+'" role="tab" tabindex="0" aria-selected="" controls="section-'+d+'">'+d+' <span class="label round">'+data.display[d].count+' </span></a></li>')
                     $('#output').append(data.display[d].content)
                    }
                }

                // Update the content of each section with the latest data
                if (data.status == 'C' || data.status == 'E'){
                    clearInterval(status_check_interval)
                }
              });
              return false;
            }
        , 2500);

    });
    {% endif %}
    </script>
{% endblock %}

{% block content %}
    {% if job %}
        <div class="page-header">
          <h2>JOB:<small>{% if script.description %}{{ script.description }}{% else %}&nbsp;{% endif %}</small></h2>
        </div>
        <div class="alert alert-success alert-dismissible" role="alert">
        <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <!-- <a href="#" class="alert-link">...</a> -->
        Current job <a class="alert-link" href="{{ url_for('public.job', job_id=job.id) }}">#{{ job.id }}</a> submitted by <span class="primary">{{ job.user.username or 'Guest' }}</span> on {{ job.created_at.strftime('%Y-%m-%d %H:%M:%S') }}
        &bull; Priority <span class="primary">{{ job.priority }}</span>
        {% if job.created_at != job.updated_at %}&bull; Updated {{ job.updated_at.strftime('%Y-%m-%d %H:%M:%S') }}{% endif %}

        {% if job.status == 'W' %}<span class="label label-warning">Waiting</span>
        {% elif job.status == 'R' %}<span class="label label-primary">Running</span>
        {% elif job.status == 'C' %}<span class="label label-success">Complete</span>
        {% elif job.status == 'X' %}<span class="label label-danger">Error</span>{% endif %}
        </div>
    {% endif %}

    <div><!-- class="tab-overlay full-height"> -->
    {% include "public/job-form.html" %}
    </div>
{% endblock %}
